name: CI

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'Logo*.png'
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Run tests
        run: |
          python3 -m unittest test_sidecar.py -v

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check for syntax errors
        run: |
          python3 -m py_compile main.py test_sidecar.py
      
      - name: Basic import check
        run: |
          python3 -c "import main; import test_sidecar"

  package:
    name: Package Installation Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: |
          python3 -m pip install --upgrade pip setuptools wheel build
      
      - name: Build package
        run: |
          python3 -m build
      
      - name: Install package
        run: |
          python3 -m pip install dist/*.whl
      
      - name: Verify entry point
        run: |
          which sidecar
          sidecar --help
          sidecar config --view
      
      - name: Test entry point works
        run: |
          sidecar config --view | grep -q "paths" || exit 1
